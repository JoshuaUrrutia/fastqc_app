#!/bin/bash
#SBATCH -J urrutia-fastqc-test-1529526503
#SBATCH -o urrutia-fastqc-test-1529526503-5044513514305753576-242ac113-0001-007.out
#SBATCH -e urrutia-fastqc-test-1529526503-5044513514305753576-242ac113-0001-007.err
#SBATCH -t 01:00:00
#SBATCH -p normal
#SBATCH -N 1 -n 1
#SBATCH -A iPlant-Collabs
##########################################################
# Agave Environment Settings 
##########################################################

# Ensure we're in the job work directory 
cd /work/05369/urrutia/stampede2/urrutia/job-5044513514305753576-242ac113-0001-007-urrutia-fastqc-test-1529526503

# Location of agave job lifecycle log file 
AGAVE_LOG_FILE=/work/05369/urrutia/stampede2/urrutia/job-5044513514305753576-242ac113-0001-007-urrutia-fastqc-test-1529526503/.agave.log


##########################################################
# Agave Utility functions 
##########################################################

# cross-plaltform function to print an ISO8601 formatted timestamp 
function agave_datetime_iso() { 
  date '+%Y-%m-%dT%H:%M:%S%z'; 
} 

# standard logging function to write agave job lifecycle logs
function agave_log_response() { 
  echo "[$(agave_datetime_iso)] ${@}"; 
} 2>&1 >> "${AGAVE_LOG_FILE}"

# Callback to signal the job has started executing user-defined logic
agave_log_response $(curl -sSk "https://agave.iplantc.org/jobs/v2/trigger/job/5044513514305753576-242ac113-0001-007/token/49c8a281-7fe2-4c01-bc71-d65e906a9019/status/RUNNING?filter=id,status" 2>&1) 


##########################################################
# Agave App and System Environment Settings 
##########################################################

# App specific module commands
module load tacc-singularity

# No custom environment variables configured for this app


##########################################################
# Begin App Wrapper Template Logic 
##########################################################

# Import Agave runtime extensions
. _lib/extend-runtime.sh

# Allow CONTAINER_IMAGE over-ride via local file
if [ -z "jurrutia/fastqc:0.11.7" ]
then
    if [ -f "./_lib/CONTAINER_IMAGE" ]; then
        CONTAINER_IMAGE=$(cat ./_lib/CONTAINER_IMAGE)
    fi
    if [ -z "jurrutia/fastqc:0.11.7" ]; then
        echo "CONTAINER_IMAGE was not set via the app or CONTAINER_IMAGE file"
        CONTAINER_IMAGE="jurrutia/ubuntu17"
    fi
fi

# Usage: container_exec IMAGE COMMAND OPTIONS
#   Example: docker run centos:7 uname -a
#            container_exec centos:7 uname -a

COMMAND="/FastQC/fastqc"
gunzip reads1.fastq.gz
PARAMS=${fastq%.gz}
echo container_exec jurrutia/fastqc:0.11.7 ${COMMAND} ${PARAMS}
container_exec jurrutia/fastqc:0.11.7 ${COMMAND} ${PARAMS}
rm ${PARAMS}



##########################################################
# End App Wrapper Template Logic 
##########################################################

# Callback to signal the job has completed all user-defined logic
agave_log_response $(curl -sSk "https://agave.iplantc.org/jobs/v2/trigger/job/5044513514305753576-242ac113-0001-007/token/49c8a281-7fe2-4c01-bc71-d65e906a9019/status/CLEANING_UP?filter=id,status" 2>&1) 


